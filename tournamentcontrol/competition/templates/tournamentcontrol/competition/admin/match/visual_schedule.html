{% extends "touchtechnology/admin/base.html" %}
{% load i18n %}
{% load common %}

{% block title %}{% trans "Visual Schedule" %} - {{ date|date }} - {{ season.title }}{% endblock %}

{% block extra_head %}
{{ block.super }}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
<style>
    .visual-schedule-container {
        display: flex;
        height: 100vh;
        overflow: hidden;
    }
    
    .match-sidebar {
        width: 300px;
        background: #f5f5f5;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        padding: 20px;
    }
    
    .schedule-grid-container {
        flex: 1;
        overflow: auto;
        padding: 20px;
    }
    
    .schedule-grid {
        display: grid;
        gap: 1px;
        background: #ddd;
        border: 1px solid #ddd;
        min-width: 800px;
    }
    
    .grid-header {
        background: #f8f9fa;
        padding: 10px;
        font-weight: bold;
        text-align: center;
        border-bottom: 2px solid #ddd;
    }
    
    .time-header {
        background: #e9ecef;
        padding: 10px;
        font-weight: bold;
        text-align: center;
        min-width: 80px;
    }
    
    .grid-cell {
        background: white;
        min-height: 60px;
        padding: 5px;
        position: relative;
        border: 1px solid #eee;
    }
    
    .grid-cell:hover {
        background: #f8f9fa;
    }
    
    .grid-cell.occupied {
        background: #e3f2fd;
    }
    
    .match-item {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
        margin: 2px 0;
        cursor: move;
        font-size: 12px;
        position: relative;
    }
    
    .match-item:hover {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .match-item.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
    }
    
    .match-item.scheduled {
        background: #e8f5e8;
        border-color: #4caf50;
    }
    
    .match-item.unscheduled {
        background: #fff3e0;
        border-color: #ff9800;
    }
    
    .division-group {
        margin-bottom: 20px;
    }
    
    .division-header {
        background: #007bff;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
        margin-bottom: 5px;
    }
    
    .division-header:hover {
        background: #0056b3;
    }
    
    .stage-group {
        margin-left: 15px;
        margin-bottom: 10px;
    }
    
    .stage-header {
        background: #6c757d;
        color: white;
        padding: 6px 10px;
        border-radius: 3px;
        cursor: pointer;
        user-select: none;
        margin-bottom: 5px;
        font-size: 13px;
    }
    
    .stage-header:hover {
        background: #545b62;
    }
    
    .match-list {
        margin-left: 10px;
    }
    
    .collapsed .stage-group,
    .collapsed .match-list {
        display: none;
    }
    
    .toolbar {
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .toolbar h1 {
        margin: 0;
        font-size: 20px;
    }
    
    .toolbar-actions {
        display: flex;
        gap: 10px;
    }
    
    .btn {
        padding: 8px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        border-color: #0056b3;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
        border-color: #6c757d;
    }
    
    .btn-secondary:hover {
        background: #545b62;
        border-color: #545b62;
    }
    
    .drop-zone {
        border: 2px dashed #007bff;
        background: rgba(0, 123, 255, 0.1);
    }
    
    @media (max-width: 768px) {
        .visual-schedule-container {
            flex-direction: column;
            height: auto;
        }
        
        .match-sidebar {
            width: 100%;
            height: 200px;
        }
        
        .toolbar {
            text-align: center;
        }
        
        .toolbar h1 {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .toolbar-actions {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="visualSchedule()" class="visual-schedule-container">
    <!-- Form for submitting changes -->
    <form id="schedule-form" method="post" style="display: none;">
        {% csrf_token %}
        {{ formset.management_form }}
        {% for form in formset %}
            {{ form.id }}
            <input type="hidden" :name="'{{ form.time.html_name }}'" :value="matches[{{ form.instance.id }}]?.time || ''">
            <input type="hidden" :name="'{{ form.play_at.html_name }}'" :value="matches[{{ form.instance.id }}]?.play_at || ''">
        {% endfor %}
    </form>

    <!-- Toolbar -->
    <div class="toolbar">
        <h1>{% trans "Visual Schedule" %} - {{ date|date }} - {{ season.title }}</h1>
        <div class="toolbar-actions">
            <button @click="saveChanges()" class="btn btn-primary" :disabled="!hasChanges">
                {% trans "Save" %}
            </button>
            <button @click="cancelChanges()" class="btn btn-secondary" :disabled="!hasChanges">
                {% trans "Cancel" %}
            </button>
            <a href="{{ season.urls.edit }}" class="btn">
                {% trans "Back to Season" %}
            </a>
        </div>
    </div>

    <!-- Left sidebar with match hierarchy -->
    <div class="match-sidebar">
        <h3>{% trans "Matches" %}</h3>
        
        <!-- Unscheduled matches section -->
        <div class="division-group">
            <div class="division-header" @click="toggleSection('unscheduled')">
                <span x-show="!collapsedSections.unscheduled">▼</span>
                <span x-show="collapsedSections.unscheduled">▶</span>
                {% trans "Unscheduled" %} (<span x-text="unscheduledCount"></span>)
            </div>
            <div x-show="!collapsedSections.unscheduled" class="match-list">
                <template x-for="match in unscheduledMatches" :key="match.id">
                    <div 
                        class="match-item unscheduled"
                        draggable="true"
                        @dragstart="startDrag(match, $event)"
                        @dragend="endDrag($event)"
                        :data-match-id="match.id"
                    >
                        <div x-text="match.teams" class="font-weight-bold"></div>
                        <div x-text="match.stage" class="text-muted small"></div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Division/Stage hierarchy -->
        {% for division, stages in matches_hierarchy.items %}
        <div class="division-group">
            <div class="division-header" @click="toggleSection('div_{{ division.id }}')">
                <span x-show="!collapsedSections.div_{{ division.id }}">▼</span>
                <span x-show="collapsedSections.div_{{ division.id }}">▶</span>
                {{ division.title }}
            </div>
            <div x-show="!collapsedSections.div_{{ division.id }}">
                {% for stage, stage_matches in stages.items %}
                <div class="stage-group">
                    <div class="stage-header" @click="toggleSection('stage_{{ stage.id }}')">
                        <span x-show="!collapsedSections.stage_{{ stage.id }}">▼</span>
                        <span x-show="collapsedSections.stage_{{ stage.id }}">▶</span>
                        {{ stage.title }} ({{ stage_matches|length }})
                    </div>
                    <div x-show="!collapsedSections.stage_{{ stage.id }}" class="match-list">
                        {% for match in stage_matches %}
                        <div 
                            class="match-item"
                            :class="matches[{{ match.id }}]?.scheduled ? 'scheduled' : 'unscheduled'"
                            draggable="true"
                            @dragstart="startDrag(getMatch({{ match.id }}), $event)"
                            @dragend="endDrag($event)"
                            :data-match-id="{{ match.id }}"
                        >
                            <div class="font-weight-bold">{{ match.get_home_team.title }} vs {{ match.get_away_team.title }}</div>
                            <div class="text-muted small">Round {{ match.round }}</div>
                            <div x-show="matches[{{ match.id }}]?.time" class="text-info small">
                                <span x-text="matches[{{ match.id }}]?.time"></span> - 
                                <span x-text="matches[{{ match.id }}]?.place"></span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Main schedule grid -->
    <div class="schedule-grid-container">
        <div class="schedule-grid" :style="gridStyle">
            <!-- Headers -->
            <div class="grid-header"></div>
            {% for place in places %}
            <div class="grid-header">{{ place.abbreviation|default:place.title }}</div>
            {% endfor %}

            <!-- Time slots and grid cells -->
            <template x-for="(timeslot, timeIndex) in timeslots" :key="timeslot">
                <template>
                    <!-- Time header -->
                    <div class="time-header" x-text="timeslot"></div>
                    
                    <!-- Grid cells for each place -->
                    {% for place in places %}
                    <div 
                        class="grid-cell"
                        :class="{ 'occupied': isOccupied('{{ place.id }}', timeslot), 'drop-zone': dragTarget?.place == '{{ place.id }}' && dragTarget?.time == timeslot }"
                        @dragover.prevent="handleDragOver($event, '{{ place.id }}', timeslot)"
                        @dragleave="handleDragLeave($event)"
                        @drop="handleDrop($event, '{{ place.id }}', timeslot)"
                        :data-place="{{ place.id }}"
                        :data-time="timeslot"
                    >
                        <template x-for="match in getMatchesAt('{{ place.id }}', timeslot)" :key="match.id">
                            <div 
                                class="match-item scheduled"
                                draggable="true"
                                @dragstart="startDrag(match, $event)"
                                @dragend="endDrag($event)"
                                :data-match-id="match.id"
                            >
                                <div x-text="match.teams" class="font-weight-bold"></div>
                                <div x-text="match.stage" class="text-muted small"></div>
                            </div>
                        </template>
                    </div>
                    {% endfor %}
                </template>
            </template>
        </div>
    </div>
</div>

<script>
function visualSchedule() {
    return {
        matches: {},
        originalMatches: {},
        collapsedSections: {},
        draggedMatch: null,
        dragTarget: null,
        hasChanges: false,
        
        init() {
            // Initialize matches data from Django context
            {% for form in formset %}
            this.matches[{{ form.instance.id }}] = {
                id: {{ form.instance.id }},
                teams: '{{ form.instance.get_home_team.title|escapejs }} vs {{ form.instance.get_away_team.title|escapejs }}',
                stage: '{{ form.instance.stage.title|escapejs }}',
                time: '{{ form.instance.time|default:""|time:"H:i" }}',
                play_at: '{{ form.instance.play_at.id|default:"" }}',
                place: '{{ form.instance.play_at.title|default:""|escapejs }}',
                scheduled: {{ form.instance.time|yesno:"true,false" }}
            };
            {% endfor %}
            
            // Store original state for change detection
            this.originalMatches = JSON.parse(JSON.stringify(this.matches));
            
            // Initialize timeslots
            this.timeslots = [
                {% for timeslot in timeslots %}
                '{{ timeslot|time:"H:i" }}',
                {% endfor %}
            ];
            
            // Check for mobile and show warning
            if (window.innerWidth < 768) {
                alert('{% trans "This interface is designed for desktop use. Please use a desktop computer for the best experience." %}');
            }
        },
        
        get gridStyle() {
            const placeCount = {{ places|length }};
            return `grid-template-columns: 80px repeat(${placeCount}, 1fr);`;
        },
        
        get unscheduledMatches() {
            return Object.values(this.matches).filter(match => !match.scheduled);
        },
        
        get unscheduledCount() {
            return this.unscheduledMatches.length;
        },
        
        getMatch(id) {
            return this.matches[id];
        },
        
        toggleSection(section) {
            this.collapsedSections[section] = !this.collapsedSections[section];
        },
        
        startDrag(match, event) {
            this.draggedMatch = match;
            event.dataTransfer.setData('text/plain', match.id);
            event.target.classList.add('dragging');
        },
        
        endDrag(event) {
            event.target.classList.remove('dragging');
            this.draggedMatch = null;
            this.dragTarget = null;
        },
        
        handleDragOver(event, placeId, time) {
            event.preventDefault();
            this.dragTarget = { place: placeId, time: time };
        },
        
        handleDragLeave(event) {
            if (!event.currentTarget.contains(event.relatedTarget)) {
                this.dragTarget = null;
            }
        },
        
        handleDrop(event, placeId, time) {
            event.preventDefault();
            const matchId = event.dataTransfer.getData('text/plain');
            
            if (matchId && this.matches[matchId]) {
                // Update match scheduling
                this.matches[matchId].time = time;
                this.matches[matchId].play_at = placeId;
                this.matches[matchId].place = this.getPlaceName(placeId);
                this.matches[matchId].scheduled = true;
                
                this.checkForChanges();
            }
            
            this.dragTarget = null;
        },
        
        getPlaceName(placeId) {
            // This should be populated from Django context
            const places = {
                {% for place in places %}
                '{{ place.id }}': '{{ place.title|escapejs }}',
                {% endfor %}
            };
            return places[placeId] || '';
        },
        
        isOccupied(placeId, time) {
            return Object.values(this.matches).some(match => 
                match.play_at == placeId && match.time == time
            );
        },
        
        getMatchesAt(placeId, time) {
            return Object.values(this.matches).filter(match => 
                match.play_at == placeId && match.time == time
            );
        },
        
        checkForChanges() {
            this.hasChanges = JSON.stringify(this.matches) !== JSON.stringify(this.originalMatches);
        },
        
        saveChanges() {
            if (!this.hasChanges) return;
            
            if (confirm('{% trans "Save all scheduling changes?" %}')) {
                document.getElementById('schedule-form').submit();
            }
        },
        
        cancelChanges() {
            if (!this.hasChanges) return;
            
            if (confirm('{% trans "Discard all unsaved changes?" %}')) {
                this.matches = JSON.parse(JSON.stringify(this.originalMatches));
                this.hasChanges = false;
            }
        }
    }
}
</script>
{% endblock %}